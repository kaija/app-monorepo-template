name: Rollback Deployment

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to rollback'
        required: true
        type: choice
        options:
        - prod
        - staging
      rollback_type:
        description: 'Type of rollback'
        required: true
        type: choice
        options:
        - backend-only
        - frontend-only
        - full-rollback
        - database-rollback
      target_version:
        description: 'Target version/commit to rollback to (optional)'
        required: false
        type: string

env:
  AWS_REGION: us-east-1
  ECR_REPOSITORY: line-commerce-backend

jobs:
  rollback:
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        ref: ${{ github.event.inputs.target_version || github.ref }}
    
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}
    
    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ~1.0
        terraform_wrapper: false
    
    - name: Initialize Terraform
      run: |
        cd infra
        terraform init -backend-config=backend-${{ github.event.inputs.environment }}.hcl
        terraform workspace select ${{ github.event.inputs.environment }}
    
    - name: Rollback backend service
      if: contains(github.event.inputs.rollback_type, 'backend') || github.event.inputs.rollback_type == 'full-rollback'
      run: |
        ENV=${{ github.event.inputs.environment }}
        
        # Get current task definition
        CURRENT_TASK_DEF=$(aws ecs describe-services \
          --cluster line-commerce-${ENV}-backend-cluster \
          --services line-commerce-${ENV}-backend \
          --query 'services[0].taskDefinition' \
          --output text)
        
        echo "Current task definition: $CURRENT_TASK_DEF"
        
        # Get task definition revisions
        TASK_FAMILY="line-commerce-${ENV}-backend"
        REVISIONS=$(aws ecs list-task-definitions \
          --family-prefix $TASK_FAMILY \
          --status ACTIVE \
          --sort DESC \
          --query 'taskDefinitionArns[0:5]' \
          --output text)
        
        echo "Available revisions:"
        echo "$REVISIONS"
        
        # Get the previous revision (second in the list)
        PREVIOUS_REVISION=$(echo "$REVISIONS" | awk '{print $2}')
        
        if [ -z "$PREVIOUS_REVISION" ]; then
          echo "‚ùå No previous revision found for rollback"
          exit 1
        fi
        
        echo "Rolling back to: $PREVIOUS_REVISION"
        
        # Update service to use previous revision
        aws ecs update-service \
          --cluster line-commerce-${ENV}-backend-cluster \
          --service line-commerce-${ENV}-backend \
          --task-definition $PREVIOUS_REVISION
        
        # Wait for rollback to complete
        aws ecs wait services-stable \
          --cluster line-commerce-${ENV}-backend-cluster \
          --services line-commerce-${ENV}-backend
        
        echo "‚úÖ Backend rollback completed"
    
    - name: Rollback frontend
      if: contains(github.event.inputs.rollback_type, 'frontend') || github.event.inputs.rollback_type == 'full-rollback'
      run: |
        # Get previous deployment from Vercel
        # This would typically involve Vercel CLI or API calls
        echo "Frontend rollback would be performed here"
        echo "This requires Vercel-specific rollback procedures"
        
        # For now, we'll redeploy the current version
        cd frontend
        npm ci
        npm run build
        
        # Deploy with Vercel
        npx vercel --token ${{ secrets.VERCEL_TOKEN }} --prod
        
        echo "‚úÖ Frontend rollback completed"
    
    - name: Rollback database migrations
      if: github.event.inputs.rollback_type == 'database-rollback'
      run: |
        ENV=${{ github.event.inputs.environment }}
        
        echo "‚ö†Ô∏è  Database rollback is a dangerous operation!"
        echo "This will rollback the last migration."
        
        # Setup Python environment
        cd backend
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -e .
        
        # Get current migration
        if [ "$ENV" = "prod" ]; then
          DATABASE_URL="${{ secrets.PROD_DATABASE_URL }}"
        else
          DATABASE_URL="${{ secrets.STAGING_DATABASE_URL }}"
        fi
        
        # Show current migration
        echo "Current migration status:"
        alembic current
        
        # Rollback one migration
        echo "Rolling back one migration..."
        alembic downgrade -1
        
        # Show new status
        echo "New migration status:"
        alembic current
        
        echo "‚úÖ Database rollback completed"
    
    - name: Verify rollback
      run: |
        ENV=${{ github.event.inputs.environment }}
        
        # Get backend URL
        cd infra
        BACKEND_URL=$(terraform output -raw backend_api_url)
        
        # Wait for services to stabilize
        sleep 30
        
        # Health check
        if curl -f -s "$BACKEND_URL/healthz" > /dev/null; then
          echo "‚úÖ Backend health check passed after rollback"
        else
          echo "‚ùå Backend health check failed after rollback"
          exit 1
        fi
        
        # Additional verification
        echo "Rollback verification completed for $ENV environment"
        echo "Rollback type: ${{ github.event.inputs.rollback_type }}"
        echo "Target version: ${{ github.event.inputs.target_version || 'previous' }}"
    
    - name: Notify rollback completion
      run: |
        echo "üîÑ Rollback completed successfully!"
        echo "Environment: ${{ github.event.inputs.environment }}"
        echo "Rollback type: ${{ github.event.inputs.rollback_type }}"
        echo "Please verify that all services are functioning correctly."