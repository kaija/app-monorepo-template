name: Continuous Integration

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  # Detect what changed to optimize CI runs
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      frontend: ${{ steps.changes.outputs.frontend }}
      backend: ${{ steps.changes.outputs.backend }}
      database: ${{ steps.changes.outputs.database }}
      infra: ${{ steps.changes.outputs.infra }}
      docs: ${{ steps.changes.outputs.docs }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Detect changes
      uses: dorny/paths-filter@v2
      id: changes
      with:
        filters: |
          frontend:
            - 'frontend/**'
          backend:
            - 'backend/**'
          database:
            - 'backend/alembic/**'
            - 'backend/app/models/**'
          infra:
            - 'infra/**'
          docs:
            - 'docs/**'
            - '*.md'

  # Frontend CI
  frontend-ci:
    needs: detect-changes
    if: needs.detect-changes.outputs.frontend == 'true'
    uses: ./.github/workflows/frontend-ci.yml

  # Backend CI
  backend-ci:
    needs: detect-changes
    if: needs.detect-changes.outputs.backend == 'true'
    uses: ./.github/workflows/backend-ci.yml

  # Database CI
  database-ci:
    needs: detect-changes
    if: needs.detect-changes.outputs.database == 'true'
    uses: ./.github/workflows/database-ci.yml

  # Integration tests across components
  integration-tests:
    runs-on: ubuntu-latest
    needs: [detect-changes, frontend-ci, backend-ci]
    if: always() && (needs.detect-changes.outputs.frontend == 'true' || needs.detect-changes.outputs.backend == 'true')
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Run full integration tests
      run: |
        # Run the complete integration test suite
        chmod +x scripts/run-integration-tests.sh
        ./scripts/run-integration-tests.sh
    
    - name: Upload integration test results
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: integration-test-results
        path: |
          test-results/
          logs/
        retention-days: 7

  # Security scanning across the entire codebase
  security-scan:
    runs-on: ubuntu-latest
    needs: detect-changes
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'sarif'
        output: 'trivy-results.sarif'
    
    - name: Upload Trivy scan results to GitHub Security tab
      uses: github/codeql-action/upload-sarif@v2
      if: always()
      with:
        sarif_file: 'trivy-results.sarif'
    
    - name: Run CodeQL Analysis
      uses: github/codeql-action/init@v2
      with:
        languages: javascript, python
    
    - name: Autobuild
      uses: github/codeql-action/autobuild@v2
    
    - name: Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v2

  # Documentation validation
  docs-validation:
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.docs == 'true'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
    
    - name: Install markdown linter
      run: npm install -g markdownlint-cli
    
    - name: Lint markdown files
      run: |
        markdownlint '**/*.md' --ignore node_modules --ignore .git
    
    - name: Check for broken links
      uses: gaurav-nelson/github-action-markdown-link-check@v1
      with:
        use-quiet-mode: 'yes'
        use-verbose-mode: 'yes'
        config-file: '.github/markdown-link-check-config.json'

  # Performance benchmarking
  performance-tests:
    runs-on: ubuntu-latest
    needs: [backend-ci, frontend-ci]
    if: always() && github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Start services for performance testing
      run: |
        docker-compose -f docker-compose.test.yml up -d
        sleep 30  # Wait for services to be ready
    
    - name: Install k6
      run: |
        sudo gpg -k
        sudo gpg --no-default-keyring --keyring /usr/share/keyrings/k6-archive-keyring.gpg --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69
        echo "deb [signed-by=/usr/share/keyrings/k6-archive-keyring.gpg] https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
        sudo apt-get update
        sudo apt-get install k6
    
    - name: Run performance tests
      run: |
        # Create basic performance test script
        cat > performance-test.js << 'EOF'
        import http from 'k6/http';
        import { check, sleep } from 'k6';
        
        export let options = {
          stages: [
            { duration: '30s', target: 10 },
            { duration: '1m', target: 20 },
            { duration: '30s', target: 0 },
          ],
        };
        
        export default function () {
          let response = http.get('http://localhost:8000/healthz');
          check(response, {
            'status is 200': (r) => r.status === 200,
            'response time < 500ms': (r) => r.timings.duration < 500,
          });
          sleep(1);
        }
        EOF
        
        k6 run performance-test.js
    
    - name: Cleanup
      if: always()
      run: |
        docker-compose -f docker-compose.test.yml down -v

  # Final CI status check
  ci-status:
    runs-on: ubuntu-latest
    needs: [
      detect-changes,
      frontend-ci,
      backend-ci,
      database-ci,
      integration-tests,
      security-scan,
      docs-validation
    ]
    if: always()
    
    steps:
    - name: Check CI status
      run: |
        echo "CI Pipeline Status Summary:"
        echo "=========================="
        echo "Frontend CI: ${{ needs.frontend-ci.result || 'skipped' }}"
        echo "Backend CI: ${{ needs.backend-ci.result || 'skipped' }}"
        echo "Database CI: ${{ needs.database-ci.result || 'skipped' }}"
        echo "Integration Tests: ${{ needs.integration-tests.result || 'skipped' }}"
        echo "Security Scan: ${{ needs.security-scan.result || 'skipped' }}"
        echo "Docs Validation: ${{ needs.docs-validation.result || 'skipped' }}"
        
        # Check if any required job failed
        if [[ "${{ needs.frontend-ci.result }}" == "failure" ]] || \
           [[ "${{ needs.backend-ci.result }}" == "failure" ]] || \
           [[ "${{ needs.database-ci.result }}" == "failure" ]] || \
           [[ "${{ needs.integration-tests.result }}" == "failure" ]] || \
           [[ "${{ needs.security-scan.result }}" == "failure" ]]; then
          echo "❌ CI Pipeline failed - one or more jobs failed"
          exit 1
        else
          echo "✅ CI Pipeline passed - all jobs completed successfully"
        fi